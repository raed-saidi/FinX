import{j as e}from"./@radix-D8tIKeo-.js";import{z as u,a as b,C as g,u as k,F as E,t as R}from"./@zod-2qqdh1cM.js";import{B as h,p as Q,e as N,ak as v,al as y,am as S,an as C,ao as w,ap as x,W as V,a3 as q,X as z,w as _,ai as B,r as L,k as T,I as H}from"./index-rPJfPIfq.js";import{c as P}from"./@react-router-D1ODL_Ub.js";import{g as F}from"./name-Bg7MBXU_.js";import{k as I,h as M}from"./@tanstack-nMqraTcu.js";import{a as U}from"./all-pipeline-runs-query-C2PqNvKV.js";import{f as A}from"./pipeline-run-detail-query-CwgnhhNe.js";import{u as D}from"./update-snapshot-C3TLBVmM.js";function K({isPending:s}){const r=P();return e.jsxs("div",{className:"flex items-center justify-end gap-2 p-5",children:[e.jsx(h,{type:"button",onClick:()=>r(-1),intent:"secondary",size:"md",children:"Cancel"}),e.jsxs(h,{type:"submit",size:"md",disabled:s,children:[s&&e.jsx("div",{className:"h-4 w-4 animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Create Snapshot"]})]})}function O(){return e.jsx("div",{className:"px-5 py-3",children:e.jsx("h1",{className:"text-display-xs font-semibold",children:"Create Snapshot"})})}const W=u.object({name:u.string().min(1,"Name is required"),pipeline:u.string().uuid("Invalid pipeline ID"),run:u.string().min(1,"Run is required")});function X({pipeline:s}){const{control:r,resetField:d}=b(),t=I({...Q.pipelineListInfinite({sort_by:"desc:latest_run"}),throwOnError:!0});if(t.isPending)return e.jsx(N,{className:"h-7 w-[300px]"});if(t.isError)return e.jsx("p",{children:"Error fetching pipelines"});const l=t.data?.pages.flatMap(o=>o.items);return e.jsx(g,{control:r,name:"pipeline",render:({field:{onChange:o,ref:i,...a}})=>e.jsxs(v,{disabled:!!s,...a,onValueChange:n=>{d("run"),o(n)},children:[e.jsx(y,{ref:i,className:"border border-theme-border-moderate text-text-md disabled:bg-neutral-100 data-[error=true]:border-error-500",children:e.jsx("div",{className:"truncate",children:e.jsx(S,{placeholder:"Select a pipeline"})})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs(w,{viewportClassName:"max-h-[300px]",children:[s&&e.jsx(x,{className:"flex items-center gap-1",value:s.id,children:e.jsx(j,{name:s.name})},s.id),!s&&l.map(n=>e.jsx(x,{value:n.id,children:e.jsx(j,{name:n.name})},n.id))]}),t.hasNextPage&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] fill-theme-border-moderate"}),e.jsx("button",{type:"button",onClick:()=>t.fetchNextPage(),className:"flex w-full rounded-sm bg-theme-surface-primary px-2 py-1 hover:bg-theme-surface-tertiary",children:e.jsxs("div",{className:"flex items-center gap-1",children:[t.isFetchingNextPage&&e.jsx("div",{role:"alert","aria-busy":"true",className:"full h-[20px] w-[20px] animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Load more"]})})]})]})})]})})}function j({name:s}){return e.jsxs("div",{className:"flex items-center gap-1 text-text-md",children:[e.jsx(V,{className:"size-4 shrink-0 fill-primary-400"}),e.jsx("div",{className:"truncate",children:s})]})}function Y({run:s}){const{watch:r,control:d,setValue:t,getValues:l}=b(),o=r("pipeline"),i=I({...U({params:{pipeline_id:o,sort_by:"desc:created"}})});if(i.isPending)return e.jsx(N,{className:"h-7 w-[300px]"});if(i.isError)return e.jsx("p",{children:"Error fetching runs"});const a=i.data?.pages.flatMap(n=>n.items);return e.jsx(g,{control:d,name:"run",render:({field:{onChange:n,ref:m,...p}})=>e.jsxs(v,{disabled:!!s||!o,...p,onValueChange:c=>{l("name")||t("name",F()),n(c)},children:[e.jsx(y,{ref:m,className:"border border-theme-border-moderate text-text-md disabled:bg-neutral-100 data-[error=true]:border-error-500",children:e.jsx("div",{className:"truncate",children:e.jsx(S,{placeholder:"Select a run"})})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs(w,{viewportClassName:"max-h-[300px]",children:[s&&e.jsx(x,{value:s.id,children:e.jsx(f,{name:s.name,status:s.body?.status??null})}),!s&&a.map(c=>e.jsx(x,{value:c.id,children:e.jsx(f,{name:c.name,status:c.body?.status??null})},c.id))]}),i.hasNextPage&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-[1px] fill-theme-border-moderate"}),e.jsx("button",{type:"button",onClick:()=>i.fetchNextPage(),className:"flex w-full rounded-sm bg-theme-surface-primary px-2 py-1 hover:bg-theme-surface-tertiary",children:e.jsxs("div",{className:"flex items-center gap-1",children:[i.isFetchingNextPage&&e.jsx("div",{role:"alert","aria-busy":"true",className:"full h-[20px] w-[20px] animate-spin rounded-rounded border-2 border-theme-text-negative border-b-theme-text-brand"}),"Load more"]})})]})]})})]})})}function f({name:s,status:r}){return e.jsxs("div",{className:"flex items-center gap-1 text-text-md",children:[e.jsx(q,{className:`h-4 w-4 shrink-0 ${z(r)}`}),e.jsx("div",{className:"truncate",children:s})]})}function $(s){const r=P(),d=M(),{toast:t}=_(),{mutate:l,isPending:o}=D({onSuccess(a){d.invalidateQueries({queryKey:[...B.all,a.id]}),r(L.projects.snapshots.detail.overview(a.id))},onError(a){t({status:"error",description:a instanceof Error?a.message:"Failed to create snapshot",rounded:!0})}});async function i({name:a,run:n}){if(s!==null){l({snapshotId:s,payload:{name:a}});return}let m;try{m=(await A({runId:n})).resources?.snapshot?.id}catch{t({status:"error",emphasis:"subtle",description:"Failed to fetch run",rounded:!0});return}if(!m)return t({status:"error",emphasis:"subtle",description:"Snapshot not found",rounded:!0});l({snapshotId:m,payload:{name:a}})}return{handleCreateSnapshot:i,isPending:o}}function ie({run:s}){const r=k({resolver:R(W),defaultValues:{name:s?.name?F():"",pipeline:s?.resources?.pipeline?.id||"",run:s?.id||""}}),{handleCreateSnapshot:d,isPending:t}=$(s?.resources?.snapshot?.id||null),l=s?.resources?.pipeline;return e.jsx(T,{children:e.jsx(E,{...r,children:e.jsxs("form",{className:"divide-y divide-theme-border-moderate",onSubmit:r.handleSubmit(d),children:[e.jsx(O,{}),e.jsxs("div",{className:"space-y-5 p-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Select a name for your Snapshot"}),e.jsx("p",{className:"text-text-sm text-theme-text-secondary",children:"You can keep the suggested name or create your own."})]}),e.jsx(H,{className:"w-full",...r.register("name")}),e.jsx("div",{className:"h-[1px] bg-theme-border-moderate"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Pipeline Settings"}),e.jsx("p",{className:"text-text-sm text-theme-text-secondary",children:"Select a pipeline and a pipeline run to create your snapshot"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-text-sm",children:"Pipeline"}),e.jsx(X,{pipeline:l||void 0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-text-sm",children:"Run"}),e.jsx(Y,{run:s||void 0})]})]}),e.jsx(K,{isPending:t})]})})})}export{ie as C};
